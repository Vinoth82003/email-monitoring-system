<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Client</title>
    <style>
      .output {
        display: flex;
        justify-content: space-between;
        gap: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Email Client</h1>
    <button onclick="fetchContacts()">Fetch Contacts</button>
    <button onclick="subscribeToNewEmails()">Subscribe to New Emails</button>
    <br />
    <div id="newEmailContainer"></div>
    <br />
    <div class="output">
      <h2>From: <span class="lenght-f"></span></h2>
      <ul id="from"></ul>
      <h2>To: <span class="lenght-t"></span></h2>
      <ul id="to"></ul>
    </div>
    <script>
      let all_from_emails = [];
      let all_to_emails = [];
      let uniqueFrom = [];
      let uniqueTo = [];
      let uniqueAll = [];

      function fetchContacts() {
        fetch("/fetchContacts")
          .then((response) => response.json())
          .then((contacts) => {
            all_from_emails = extractEmails(contacts.from);
            all_to_emails = extractEmails(contacts.to);

            all_from_emails.forEach((contact) => {
              if (uniqueAll.indexOf(contact) == -1) {
                uniqueAll.push(contact);
              }
            });

            all_to_emails.forEach((contact) => {
              if (uniqueAll.indexOf(contact) == -1) {
                uniqueAll.push(contact);
              }
            });

            displayContacts(all_from_emails, "from");
            displayContacts(all_to_emails, "to");
            console.log(uniqueAll.length);
          })
          .catch((error) => console.error("Error:", error));
      }

      function subscribeToNewEmails() {
        const eventSource = new EventSource("/streamNewEmails");

        eventSource.addEventListener("newEmail", function (event) {
          // Parse the JSON data sent from the server
          const emailData = JSON.parse(event.data);

          // Extract the relevant information
          const from = emailData.from;
          const subject = emailData.subject;
          const date = emailData.date;

          // Display the new email details in the UI
          const emailDetails = `From: ${from}, Subject: ${subject}, Date: ${date}`;
          displayNewEmail(emailDetails);
        });
      }

      function displayNewEmail(emailDetails) {
        // Get the container element where the email details will be displayed
        const emailContainer = document.getElementById("newEmailContainer");

        // Create a new paragraph element to display the email details
        const emailParagraph = document.createElement("p");
        emailParagraph.textContent = emailDetails;

        // Append the paragraph element to the container
        emailContainer.appendChild(emailParagraph);
      }

      function displayContacts(contacts, type) {
        let contactsList;
        if (type === "from") {
          contactsList = document.getElementById("from");
          contactsList.innerHTML = "";
          contacts.forEach((contact) => {
            if (uniqueFrom.indexOf(contact) === -1) {
              uniqueFrom.push(contact);
              let li = document.createElement("li");
              li.textContent = contact;
              contactsList.appendChild(li);
            }
          });
          document.querySelector(".lenght-f").innerHTML = uniqueFrom.length;
          console.log(uniqueFrom.length);
        } else if (type === "to") {
          contactsList = document.getElementById("to");
          contactsList.innerHTML = "";
          contacts.forEach((contact) => {
            if (uniqueTo.indexOf(contact) === -1) {
              uniqueTo.push(contact);
              let li = document.createElement("li");
              li.textContent = contact;
              contactsList.appendChild(li);
            }
          });
          document.querySelector(".lenght-t").innerHTML = uniqueTo.length;
          console.log(uniqueTo.length);
        }
      }

      const emailPattern = /([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/;

      // Function to extract email addresses from the array
      function extractEmails(emailsArray) {
        const extractedEmails = [];
        for (const item of emailsArray) {
          const match = emailPattern.exec(item);
          if (match) {
            extractedEmails.push(match[0]);
          }
        }
        return extractedEmails;
      }
    </script>
  </body>
</html>
